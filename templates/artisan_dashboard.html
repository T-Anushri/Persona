{% extends "base.html" %}

{% block title %}Artisan Dashboard - Persona{% endblock %}

{% block extra_css %}
<style>
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 60px 0 40px;
    margin-top: 56px;
}

.persona-card {
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
    padding: 20px;
    backdrop-filter: blur(10px);
}

.sync-wall {
    background: #f8fafc;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
}

.kanban-board {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 10px 0;
}

.kanban-column {
    min-width: 300px;
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.column-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e5e7eb;
}

.product-card {
    background: #f8fafc;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: move;
    transition: all 0.3s ease;
    border-left: 4px solid #6366f1;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.product-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.drop-zone {
    min-height: 100px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    margin: 10px 0;
}

.drop-zone.drag-over {
    border-color: #6366f1;
    background: #f0f4ff;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #6366f1;
}

.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<section class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-tachometer-alt me-2"></i>{{ artisan.name }}'s Dashboard</h1>
                <p class="mb-0">Manage your digital twin and products</p>
            </div>
            <div class="col-md-4">
                {% if artisan.persona %}
                <div class="persona-card">
                    <h6><i class="fas fa-robot me-2"></i>Digital Twin Status</h6>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="badge bg-success">Active</span>
                        </div>
                        <div>
                            <small>Tone: {{ artisan.persona.tone.title() }}</small><br>
                            <small>Depth: {{ artisan.persona.storytelling_depth }}/10</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Dashboard Content -->
<div class="container my-4">
    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ products|length }}</div>
            <div class="text-muted">Total Products</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ products|selectattr("status", "equalto", "published")|list|length }}</div>
            <div class="text-muted">Published</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">₹{{ products|sum(attribute='price')|int }}</div>
            <div class="text-muted">Total Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ products|sum(attribute='stock_quantity') }}</div>
            <div class="text-muted">Total Stock</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="btn btn-primary" onclick="showAddProductModal()">
            <i class="fas fa-plus me-2"></i>Add Product
        </button>
        <button class="btn btn-outline-primary" onclick="editPersona()">
            <i class="fas fa-edit me-2"></i>Edit Persona
        </button>
        <a href="{{ url_for('marketplace') }}?artisan={{ artisan.id }}" class="btn btn-outline-success">
            <i class="fas fa-eye me-2"></i>View My Story
        </a>
    </div>

    <!-- Product Sync Wall -->
    <div class="sync-wall">
        <h3><i class="fas fa-tasks me-2"></i>Product Sync Wall</h3>
        <p class="text-muted">Drag and drop products between stages</p>
        
        <div class="kanban-board" id="kanbanBoard">
            <!-- Draft Column -->
            <div class="kanban-column" data-status="draft">
                <div class="column-header">
                    <h5><i class="fas fa-edit text-secondary me-2"></i>Draft</h5>
                    <span class="badge bg-secondary">{{ products|selectattr("status", "equalto", "draft")|list|length }}</span>
                </div>
                <div class="drop-zone" data-status="draft">
                    Drop products here
                </div>
                {% for product in products %}
                    {% if product.status == 'draft' %}
                    <div class="product-card" draggable="true" data-product-id="{{ product.id }}">
                        <h6>{{ product.name }}</h6>
                        <p class="text-muted small mb-2">{{ product.description[:50] }}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-primary">₹{{ product.price }}</span>
                            <span class="badge bg-warning">Stock: {{ product.stock_quantity }}</span>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Published Column -->
            <div class="kanban-column" data-status="published">
                <div class="column-header">
                    <h5><i class="fas fa-check-circle text-success me-2"></i>Published</h5>
                    <span class="badge bg-success">{{ products|selectattr("status", "equalto", "published")|list|length }}</span>
                </div>
                <div class="drop-zone" data-status="published">
                    Drop products here
                </div>
                {% for product in products %}
                    {% if product.status == 'published' %}
                    <div class="product-card" draggable="true" data-product-id="{{ product.id }}">
                        <h6>{{ product.name }}</h6>
                        <p class="text-muted small mb-2">{{ product.ai_enriched_description[:50] }}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-success">₹{{ product.price }}</span>
                            <span class="badge bg-info">Stock: {{ product.stock_quantity }}</span>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Sold Out Column -->
            <div class="kanban-column" data-status="sold_out">
                <div class="column-header">
                    <h5><i class="fas fa-times-circle text-danger me-2"></i>Sold Out</h5>
                    <span class="badge bg-danger">{{ products|selectattr("status", "equalto", "sold_out")|list|length }}</span>
                </div>
                <div class="drop-zone" data-status="sold_out">
                    Drop products here
                </div>
                {% for product in products %}
                    {% if product.status == 'sold_out' %}
                    <div class="product-card" draggable="true" data-product-id="{{ product.id }}">
                        <h6>{{ product.name }}</h6>
                        <p class="text-muted small mb-2">{{ product.description[:50] }}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-muted">₹{{ product.price }}</span>
                            <span class="badge bg-danger">Out of Stock</span>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">Price (₹)</label>
                                <input type="number" class="form-control" id="productPrice" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3" required></textarea>
                        <small class="text-muted">Your digital twin will enhance this description with your persona's voice</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">Category</label>
                                <select class="form-select" id="productCategory">
                                    <option value="{{ artisan.craft_type }}">{{ artisan.craft_type }}</option>
                                    <option value="Pottery">Pottery</option>
                                    <option value="Textiles">Textiles</option>
                                    <option value="Jewelry">Jewelry</option>
                                    <option value="Woodwork">Woodwork</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productStock" class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control" id="productStock" value="1" min="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="culturalSignificance" class="form-label">Cultural Significance (Optional)</label>
                        <textarea class="form-control" id="culturalSignificance" rows="2" 
                                 placeholder="Share the cultural story behind this product..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addProduct()">
                    <i class="fas fa-magic me-2"></i>Create with AI Enhancement
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Drag and Drop functionality
let draggedElement = null;

$(document).ready(function() {
    initializeDragAndDrop();
});

function initializeDragAndDrop() {
    // Product cards drag events
    $('.product-card').on('dragstart', function(e) {
        draggedElement = this;
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.effectAllowed = 'move';
        e.originalEvent.dataTransfer.setData('text/html', this.outerHTML);
    });

    $('.product-card').on('dragend', function(e) {
        $(this).removeClass('dragging');
        draggedElement = null;
    });

    // Drop zones
    $('.drop-zone, .kanban-column').on('dragover', function(e) {
        e.preventDefault();
        e.originalEvent.dataTransfer.dropEffect = 'move';
        $(this).addClass('drag-over');
    });

    $('.drop-zone, .kanban-column').on('dragleave', function(e) {
        $(this).removeClass('drag-over');
    });

    $('.drop-zone, .kanban-column').on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');
        
        if (draggedElement) {
            const productId = $(draggedElement).data('product-id');
            const newStatus = $(this).data('status') || $(this).closest('.kanban-column').data('status');
            
            updateProductStatus(productId, newStatus);
        }
    });
}

function updateProductStatus(productId, newStatus) {
    $.ajax({
        url: `/api/products/${productId}/status`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function(response) {
            if (response.success) {
                // Move the card to new column
                const $card = $(draggedElement);
                const $targetColumn = $(`.kanban-column[data-status="${newStatus}"]`);
                
                $card.detach().appendTo($targetColumn);
                
                // Update badge counts
                updateColumnCounts();
                
                // Show success message
                showToast('Product status updated successfully!', 'success');
            }
        },
        error: function() {
            showToast('Failed to update product status', 'error');
        }
    });
}

function updateColumnCounts() {
    $('.kanban-column').each(function() {
        const status = $(this).data('status');
        const count = $(this).find('.product-card').length;
        $(this).find('.badge').text(count);
    });
}

function showAddProductModal() {
    $('#addProductModal').modal('show');
}

function addProduct() {
    const formData = {
        name: $('#productName').val(),
        description: $('#productDescription').val(),
        price: parseFloat($('#productPrice').val()),
        category: $('#productCategory').val(),
        stock_quantity: parseInt($('#productStock').val()),
        cultural_significance: $('#culturalSignificance').val()
    };

    if (!formData.name || !formData.description || !formData.price) {
        showToast('Please fill in all required fields', 'error');
        return;
    }

    $.ajax({
        url: '/api/products/create',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#addProductModal').modal('hide');
                showToast('Product created successfully!', 'success');
                
                // Add new product card to draft column
                const newCard = createProductCard(response.product_id, formData, response.enriched_description);
                $('.kanban-column[data-status="draft"]').append(newCard);
                
                // Reset form
                $('#addProductForm')[0].reset();
                
                // Update counts
                updateColumnCounts();
            }
        },
        error: function() {
            showToast('Failed to create product', 'error');
        }
    });
}

function createProductCard(productId, productData, enrichedDescription) {
    return `
        <div class="product-card" draggable="true" data-product-id="${productId}">
            <h6>${productData.name}</h6>
            <p class="text-muted small mb-2">${enrichedDescription.substring(0, 50)}...</p>
            <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold text-primary">₹${productData.price}</span>
                <span class="badge bg-warning">Stock: ${productData.stock_quantity}</span>
            </div>
        </div>
    `;
}

function editPersona() {
    window.location.href = '/artisan/onboard';
}

function showToast(message, type) {
    const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';
    const toast = `
        <div class="toast align-items-center text-white ${toastClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    if (!$('.toast-container').length) {
        $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
    }
    
    $('.toast-container').append(toast);
    $('.toast').last().toast('show');
}
</script>
{% endblock %}
